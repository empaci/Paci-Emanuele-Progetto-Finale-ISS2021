<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
	font-size: 93%;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 90%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 90%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	font-size: 90%;
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	font-size: 90%;
}
en{
	font-family: "Arial";
    font-size: 90%;
	background-color: #FFFFA6;
}
uc {
	font-family: "Arial";
    font-size: 90%;
	background-color: #F8CECC;
}
ia {
	font-family: "Arial";
    font-size: 90%;
	background-color: #97D077;
}
fd {
	font-family: "Arial";
    font-size: 90%;
	background-color: #CCE5FF;
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	 
    font-size: 18px;
}
k{
    color: #990000;
	font-weight: bold;
	font-size: 90%;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px;
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #ccffcc;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;

}
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}
div.remark{
	background-color: #E3F2FD;
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed

}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>parkManagerService_2</title></head>
    
<body>
<div id="top">
<h1>LABORATORIO DI INGEGNERIA DEI SISTEMI SOFTWARE <font size="5"></font> </h1>
</div>  

<div class="body"> 
<h2>Introduction</h2>
 
A company intends to build an <i>automating parking service</i> composed of a set of elements:

<ul>
<li>A software system, named <em>ParkManagerService</em>, that implements the required automation functions.</li>
<li>A <tt>DDR</tt> robot working as a <em>transport trolley</em>, that is intially situated in its <em>home</em> location. 
The <tt>transport trolley</tt> has the form of a square of side length <em>RD</em>.
</li>
<li>A <em>parking-area</em> is an empty room that includes;
	<ul>
	<li>an <em>INDOOR</em> to enter the car in the area. Facing the <tt>INDOOR</tt>, there is
	a <em>INDOOR-area</em> equipped with a <em>weigthsensor</em> that measures the <em>weigth</em> of the car;</li>
	<li>an <em>OUTDOOR</em> to exit from the <tt>parking-area</tt>. Just after the <tt>OUTDOOR</tt>, there is
	<em>OUTDOOR-area</em> equipped with a <em>outsonar</em>, used to detect the presence of a car.
	The <tt>OUTDOOR-area</tt>, once engaded by a car, should be freed within a prefixed interval of time <em>DTFREE</em>; </li>
	<li>a number <tt>N (N=6)</tt> of <em>parking-slots</em>;</li>
	<li>a <em>thermometer</em> that measures the temperature <em>TA</em> of the area;</li>
	<li>a <em>fan</em> that should be activated when <k>TA > TMAX</k>, where <em>TMAX</em> is a prefixed value (e.g. <tt>35</tt>)</li>
	</ul>
	A <em>map</em> of the parking area, represented as a grid of squares of side length <em>RD</em>, 
	is available in the file <a href="parkingMap.txt" target="code">parkingMap.txt</a>:
	<pre>
|r, 0, 0, 0, 0, 0, 0, X, 
|0, 0, <bc>X, X,</bc>  0, 0, 0, X, 
|0, 0, <bc>X, X,</bc>  0, 0, 0, X, 
|0, 0, <bc>X, X,</bc>  0, 0, 0, X, 
|0, 0, 0, 0, 0, 0, 0, X, 
|X, X, X, X, X, X, X, X, </pre>
	The map includes the positions of the  <tt>parking-slots</tt> (marked above with the symbol <k>X</k>) 
	and of the <em>fixed obstacles</em> in the area (the walls marked with the symbol <b>X</b>).
	<br/><br/>
	The area marked with <k>X</k> is a sort of 'equipped area' upon which the <tt>transport trolley</tt> cannot walk.
	Thus, to get the car in the <tt>parking-slot</tt> <ks>(2,2)</ks>, the <tt>transport trolley</tt> must
	go in cell <ks>(1,2)</ks>.
	<br/><br/>

	The proper scene for the WEnv is reported in: <a href="parkingAreaConfig.js" target="code">parkingAreaConfig.js</a>
 
	
	<center><img src="./img/parkingAreaZone.PNG" alt="parkingAreaZone.PNG" width="45%" height="32%"/></center>
</li>	
<li>a <em>parking-manager</em> (an human being) which supervises the state of the <tt>parking-area</tt>
and handles critical situations<!-- by using a software system named <em>ParkMonitoringService</em> -->. </li>
</ul>

<div class="remark">
The job of our company is to design, build and deploy the  <em>ParkManagerService</em>.
</div>

<h2>Requirements</h2>
 
<div class="remark">
The <tt>ParkManagerService</tt>  should create the <tt>ParkServiceGUI</tt> (for the client) 
and the <tt>ParkServiceStatusGUI</tt> (for the manager) and then perform the following tasks:


<ul>
 
<li><hr/>
<em>acceptIN</em>: accept the request of a client to park the car if there is at least one <tt>parking-slot</tt> available,
select a free slot identified with a unique <tt>SLOTNUM</tt>.<br/>
A request of this type can be elaborated only when the <k><tt>INDOOR-area</tt> is free</k>, 
and  the <tt>transport trolley</tt> is at <tt>home</tt> or working (<k>not stopped</k> by the manager). 
If the <tt>INDOOR-area</tt> is already engaged by a car, the request is not immediately processed 
(the client could simply wait or could - optionally - receive a proper notice). 
<br/>
  <li><em>informIN</em>: inform the client about the value of the <tt>SLOTNUM</tt>.</li> 
If  <k>SLOTNUM>0</k>:
  <ol>
   <li><em>moveToIn</em>: move the <tt>transport trolley</tt> from its current localtion to the <tt>INDOOR</tt> ;</li>
  <li><em>receipt</em>: send to the client a receipt including the value of the <tt>TOKENID</tt> ;</li> 
  <li><em>moveToSlotIn</em>: move the <tt>transport trolley</tt> from the <tt>INDOOR</tt> to the selected <tt>parking-slot</tt>;</li>
  <!-- <li>accept another request (<tt>acceptIN</tt> or <tt>acceptOUT</tt>). -->
  <li><em>backToHome</em>: if no other request is present,  move the <tt>transport trolley</tt> to its <tt>home</tt> location,
  else <em>acceptIN</em> or <em>acceptOUT</em>.</li> 
  </ol>
 </li>
If <k>SLOTNUM==0</k>: 
	<ul>
	<li><em>moveToHome</em>: if not already at home, move the <tt>transport trolley</tt> to its <tt>home</tt> location.</li> 
	</ul>
</li>


<li><hr/>
<em>acceptOUT</em>: accept the request of a client to get out the car with <tt>TOKENID</tt>.
A request of this type can be elaborated only when the <k><tt>OUTDOOR-area</tt> is free</k> 
and  the <tt>transport trolley</tt> is at <tt>home</tt> or working (<k>not stopped</k> by the manager).
If the <tt>OUTDOOR-area</tt> is still engaged by a car, the request is not immediately processed 
(the client could simply wait or could - optionally - receive a proper notice).

	<ol>
	<li><em>findSlot</em>: deduce the number of the parking slot (<em>CARSLOTNUM</em>) from the <tt>TOKENID</tt>;</li>
	<li><em>moveToSlotOut</em>: move the <tt>transport trolley</tt> from its current localtion to the <tt>CARSLOTNUM/parking-slot</tt> ;</li>
	<li><em>moveToOut</em>: move the <tt>transport trolley</tt> to the <tt>OUTDOOR</tt> ;</li>
	<li><em>moveToHome</em>: if no other request is present  move the <tt>transport trolley</tt> to its <tt>home</tt> location; <br/>
	else <em>acceptIN</em> or <em>acceptOUT</em></li> 

	</ol> 
</li>
<li>
<hr/>
<em>monitor</em>: update the <tt>ParkServiceStatusGUI</tt> with the required information about the state of the system.
</li>

<li>
<hr/>
<em>manage</em>: accept the request of the manager to stop/resume the behavior of the  <tt>transport trolley</tt>.
</li>

</ul>
<h4>About the devices</h4>
All the sensors (<tt>weigthsensor</tt>, <tt>outsonar</tt>, <tt>thermometer</tt> ) and the <tt>fan</tt> should be properly simulated
by mock-objects or mock-actors.

<h4>When using a real robot</h4>
No further requirement.

<h4>When available a Raspberry and a sonar</h4>
The <tt>outsonar</tt> could be a real device. We can simulate the presence/absence of a car.

    <h4>When using <k>only</k> the virtual robot or <k>no real sonar</k> available</h4>
Consider the new requirement:
<ul>
<li><ks>authorize</ks>: allow a manager to use the <tt>ParkServiceStatusGUI</tt> only if she/he owns <bc>proper permissions</bc>.</li>
 
</ul>

<h3>User stories</h3>
As a <bc>client - parking phase</bc> :
<ul>
<li>I intend to use a <em>ParkServiceGUI</em> provided by the <tt>ParkManagerService</tt>  to notify my interest in <i>entering</i> 
my auto in the <tt>parking-area</tt> and to receive as answer the number <em>SLOTNUM</em> of a  free parking-slot  (<tt>1&lt;=SLOTNUM&lt;=6</tt>). 
<tt>SLOTNUM<k>==0</k></tt> means that no free slot is available.</em>

</li>
<li>If <tt>SLOTNUM <k>>0</k></tt>, I move my car in front to the <tt>INDOOR</tt>, get out of the car and afterwards press a <em>CARENTER</em> button on the
<em>ParkServiceGUI</em>. Afterwards, the <tt>transport trolley</tt> takes over my car and moves it from the <tt>INDOOR</tt> 
to the selected <tt>parking-slot</tt>.
The <tt>ParkServiceGUI</tt> will show to me a receipt that includes a (unique) <em>TOKENID</em>, 
to be used in the <i>car pick up</i> phase.</li>
</ul>

As a <bc>client - car pick up phase</bc> :
<ul>
<li>I intend to use the <tt>ParkServiceGUI</tt> to submit the request to pick up my car, by sending the <tt>TOKENID</tt> previously received. </li>  
<li>Afterwards, the <tt>transport trolley</tt>  takes over my car and moves it from its <tt>parking-slot</tt> to the <tt>OUTDOOR-area</tt>.</li>
<li>I move the car, so to free the <tt>OUTDOOR-area</tt>.
</li>
 </ul>

As a <bc>parking-manager</bc>:
<ul>
<li>I intend to use the <em>ParkServiceStatusGUI</em>  provided by the <tt>ParkManagerService</tt>
to observe the <em>current state</em> of the <tt>parking area</tt>, including the value <tt>TA</tt> of the temperature,
the state of the <tt>fan</tt> and the state of the <tt>transport trolley</tt> (<k>idle, working or stopped</k>).</li>
<li>I intend to <em>stop</em> the <tt>transport trolley</tt> when <k>TA > TMAX</k>, activate the <tt>fan</tt> and 
wait until <k>TA &lt; TMAX</k>. At this time, I stop the <tt>fan</tt> and resume the behavior of the <tt>transport trolley</tt>.
Hopefully, the <b>start/stop</b> <ks>of the fan</ks> could also be automated by the <tt>ParkManagerService</tt>,
while the <b>start/stop</b> <ks>of the transport trolley</ks> is always up to me.
</li>

<li>I expect that the <tt>ParkManagerService</tt> sends to me an <em>alarm</em> if it detectes that the <tt>OUTDOOR-area</tt>
has not been cleaned within the <tt>DTFREE</tt> interval of time.</li>
</ul>

</div>

 

<h2>Requirement analysis</h2>
 In this <k>SPRINT</k> we will add <em>parking-manager</em> to the application with the relative GUI, <em>fan</em>, and <em>thermometer</em>.
 Also, we will perform the analysis so that the <em>fan</em> is activated automatically. 
 <br>
 <br>
 At the end of this <k>SPRINT</k> the <tt>parking-manager</tt> will be able to interact with the <em>ParkServiceStatusGUI</em> complete in every aspect. 
 <br>
 The graphic interface should be able to notify the <tt>parking-manager</tt> if a <tt>client</tt> has not left the <em>OUTDOOR-area</em> within the <em>DTFREE</em> interval of time. 
 Also, the <tt>parking-manager</tt> can stop and resume the <tt>transport trolley</tt>.
 </div>
 <br>
 Note: optional parts will not be discussed at this stage and will be implemented at the end.
 <br>
 <br>
 Another term to clarify:
 <ul>
	<li><em>alarm</em>: a video notice in the graphic interface that signals the <tt>park-manager</tt> that after <tt>DTFREE</tt> the <tt>OUTDOOR</tt> is still occupied
	 by a car.</li>
 </ul>
 <br>
 In this <k>SPRINT</k> we will consider only the following use-cases:
 <h4>Use-case <ks>The <k>TA</k> measured by the <tt>thermometer</tt> is increased over <k>TMAX</k></ks></h4>
 The application should be able, in order, to: 
 <br>
 <ol>
	<li>Check if the temperature measured by the <em>thermometer</em> is above <k>TMAX</k>.</li>
	<li>Send the <em>alarm</em> to the <em>parking-manager</em>.</li>
	<li>Activate the <em>fan</em>.</li>
	<li>The <em>parking-manager</em> stops the <em>Transport Trolley</em>.</li>
	<li>Check if the temperature measured by the <em>thermometer</em> is below <k>TMAX</k>.</li>
	<li>Notify the <em>parking-manager</em>.</li>
	<li>Deactivate the <em>fan</em>.</li>
	<li>The <em>parking-manager</em> starts the <em>Transport Trolley</em></li>
 </ol>
 <h4>Use-case <ks><tt>OUTDOOR-area</tt> is not free whithin <tt>DTFREE</tt></ks></h4>
 The application should be able, in order, to: 
 <br>
 <ol>
 	<li>Check if the <em>OUTDOOR-area</em> monitored by the <em>outsonar</em> is <tt>occupied</tt> for a time above <k>DTFREE</k>.</li>
	<li>Notify the <em>parking-manager</em>.</li>
	<li>Wait until the <em>OUTDOOR-area</em> is <tt>free</tt>.</li>
 </ol>

<h2>Problem analysis</h2>
Result of the previous <k>SPRINT</k> Analysis
 <table style="width:100%" border="1">
		<tr>
			<td rowspan="2" style="width:80%">
			 <img src="img/LogicalArchitecture_1.png" width="100%">
			<td>
				<a href="../../../../SPRINT1/modello/it.unibo.ParkManagerService/src/park_service_model_1.qak">Model SPRINT1</a>
			</td>
			<tr>
				<td><a href="../../../../SPRINT0/modello/it.unibo.ParkManagerService/src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a></td>
			</tr>
		</tr>
  </table>
 <br>
As stated in the previous <k>SPRINT</k>, this problem requires the communications of different components in a distributed environment, see <a href="../../../../SPRINT0/modello/it.unibo.ParkManagerService/userDocs/parkManagerService_0_c.html#problemanalysis">SPRINT0 | problem analysis</a>. 
And, following the reasoning already made, we will add the <em>thermometer</em> and <em>fan</em> as a QakActor to the already existing architecture.
   
   <h3><ks>Park-manager GUI</h3>
   <table style="width:100%" border="1">
		<tr>
			<td style="width:50%">
			   We need a graphic interface able to:
				<ul>
					<li>Shows the <em>current state</em> of the parking area:
						<ul>
							<li>Value of the temperature <tt>TA</tt>.</li>
							<li>State of the <tt>fan</tt> (on/off).</li>
							<li>State of the <tt>trolley</tt> (<k>idle, working, or stopped</k>). </li>
							<li>The start/stop botton should be active only if they can be used in that moment.</li>
							<li><ks>Optionally</ks> other helpful information such as the current robot position or the map.</li>
						</ul>
					</li>
					<li>Give the possibility to send a <ks>stop</ks> command to the <tt>trolley</tt> when <k>TA>TMAX</k>.</li>
					<li>Give the possibility to send a <ks>start</ks> command to the <tt>trolley</tt> when <k>TA<TMAX</k> and the trolley is stopped.</li>
					<li>Show a visual notice when <tt>TA</tt> surpasses <tt>TMAX</tt> and when <tt>TA</tt> goes below <tt>TMAX</tt>.</li>
					<li>Show a visual notice if the <em>OUTDOOR-area</em> has not been cleaned within the <tt>DTFREE</tt> interval of time, and
						hide it after it returns <tt>free</tt>.</li>
				</ul>
				<br>
				To grant wide usability the system should be developed as a Web-application. 
				<br>
				<k>SpringBoot</k> should be used to reduce development time.
				<br>
				<br>
				The html page will incude a INPUT section (requirement: <em>manage</em>) and an OUTPUT section (requirement: <em>monitor</em>).
			</td>
			<td>
				<center><img src="img\parkservicestatusGui_example.png" width="80%" height="80%"></center>
			</td>
		</tr>
	</table>
   <br>
   <h3>Current state of the system</h3>
   Because we have multiple resources that are a source of data and a couple of components (<tt>ParkmanagerService</tt> and <tt>ParkServiceStatusGUI</tt>) that observe them, we need to discuss the best way to make them available.
   There are different approaches we can take:
	<table style="width:100%" border="1">
		<tr>
			<td style="width:50%">
			Add a new actor that stores the resources information as a CoAp Observable entity.
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>Can be be used by every component.</dd>
					<dd>Represent the current state of the system.</dd>
					<dd>A new component that needs any resource can use this instead.</dd>
					<dd>Every other component that could need more resources needs to observe one single component, so it simplify the overall architecture.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Add a new component that is not strictly necessary.</dd>
				</dl>
			</td>
		</tr>
		<tr>
			<td style="width:50%">
			No new element is introduced, every components observe the resource they are interested in.
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>No new elements.</dd>
					<dd>Observe only the resources they need.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Double code for each observing component.</dd>
				    <dd>Every component need to know and observe every resource that they need means adding extra complexity to that component.</dd>
				</dl>
			</td>
			
		</tr>
	</table>
	<br>
	Given the benefit, we prefer to add the new component: <tt>ParkingState</tt>.
 <h3>Components</h3>
 We can add to the application 4 macro-components:
 <ul>
	<li><ks>ParkingState</ks>: used to keep the current state of the system grouping the information from the resources.</li>
	<li><ks>ParkManagerStatusGUI</ks>: used by the <tt>park-manager</tt> to communicate with the <tt>ParkmanagerService</tt>.</li>
	<li><ks>Thermometer resource</ks>: a resource that receives, stores, and makes available the data from the <em>thermometer</em>.</li>
	<li><ks>Fan</ks>: a resource that activates the <em>fan</em>.</li>
 </ul>
 We need to modify 2 components:
  <ul>
	<li><ks>Transport trolley</ks>: add the state <k>idle, working, or stopped</k>.</li>
	<li><ks>Sonar</ks>: add the logic to notify the <tt>park-manager</tt> after <tt>DTFREE</tt>.</li>
 </ul>
 <h4>ParkingState</h4>
 This component can observe every resource in our application a make that information available as a CoAp observable resource, as already observed the best way to realize it, see <a href="../../../../SPRINT0/modello/it.unibo.ParkManagerService/userDocs/parkManagerService_0_c.html#weightsensor">SPRINT0 | Weight-sensor-resource</a>.
 <br>
 The string format used to represent this information should be chosen during the project phase since there is no need for anything particolar.
  <br>
 <tt>ParkManagerService</tt> will be changed to observe this resource.
 <h4>ParkManagerStatusGUI</h4>
 Mock used to simulate the park-manager in the model.
 Should be able to:
 <ol>
	<li>Send stop/start messages to the <tt>Trolley</tt>.</li>
	<li>Observe <tt>ParkingState</tt>.</li>
	<li>Being notifed if <em>OUTDOOR-area</em> is occupied for a time above <tt>DTFREE</tt>.</li>
	<li>Being notified when <k>TA</k> surpasses or goes below <k>TMAX</k>.</li>
 </ol>
 
 <h4>Trolley</h4>
  We can modify the esisting component <tt>transportrrolley</tt> to work as CoAp observable and able to change the state with: <k>idle, working, or stopped.</k>
  
 <h4>Sonar</h4>
 We need to modify this <tt>sonarresource</tt>, or at least add logic to notify the <tt>ParkManagerStatusGUI</tt> if the <em>OUTDOOR-area</em> is occupied for a time above <tt>DTFREE</tt>.
 <br>
 There are different approach we can take:
 <table style="width:100%" border="1">
		<tr>
			<td style="width:50%">
			<tt>Sonarresource</tt> sends an events after <tt>DTFREE</tt> time has passed and the state remained <ks>"occupied"</ks>
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>Easy to realize.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Logic inside the sensor.</dd>
				    <dd>Hard reusability.</dd>
				</dl>
			</td>
		</tr>
		<tr>
			<td style="width:50%">
			Adding an external actor with the logic
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>The logic is separated, meaning future requirements changes won't impact the <tt>sonarresource</tt>.</dd>
					<dd><tt>sonarresource</tt> can be reused unchanged in other applications.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Not strictly needed.</dd>
				</dl>
			</td>
		</tr>
	</table>
 <br>
 To simplify the model the first option is chosen and will be included in the model after the Analysis. 
 During the project phase, it can be changed based on the architecture adopted.
 
 <h4>Thermometer</h4>
 We need to add a new component: <tt>Thermometer resource</tt>.
	<br>
	<tt>Thermometer resource</tt> receives data from a external <em>thermometer</em>, which means that it must store the information regarding the room temperature and makes them available to the other entities in the system.
	<br><br>
	This component is similar to the <tt>weightsensor</tt> already introduced, and as already observed the best way to realize it is to have an observable resource, see <a href="../../../../SPRINT0/modello/it.unibo.ParkManagerService/userDocs/parkManagerService_0_c.html#weightsensor">SPRINT0 | Weight-sensor-resource</a>. 
	In particular, we can define <tt>Thermometer resource</tt> as a <k>CoAp</k> observable actor. 
	<br>
	<br>
	A mock of the thermometer is required to simulate the real sensor. The decision around the nature of the mock itself is left during the project phase.
 
 <h4>Fan</h4>
 CoAp observable object, mock of the real fan, can change the state to: "on" and "off".
 
 <h3>Other relevant aspects</h3>

  <h4>Trolley start and stop</h4>
  
	To start/stop the trolley (requirement: <em>manage</em>) we chose that <tt>ParkServiceStatusGUI</tt> sends a dispatch to the <tt>ParkManagerService</tt> that propagates it to the <tt>trolley</tt>.
	<br>
	<tt>ParkServiceStatusGUI</tt> sends the message to the <tt>ParkManagerService</tt> and not the trolley because the trolley is the logic adopted to move the robot. While <tt>ParkManagerService</tt>
	is the application core logic used to interact with the other components.
	<br>
	We choose a dispatch instead of a request because the state of the trolley will change in the UI so the <em>park-manager</em> can see if it was successful.
	We don't use an Event because we don't want it to be lost.
	<br>
	<br>
	When the trolley is asked to stop it moves until it finishes the current task, so if it was a <em>pick-up</em> or a <em>parking</em> request the client is not left waiting.
 
 <h4>Temperature check and fan activation</h4>
	We need to introduce two new element: fan and thermometer. We need to activate the fan when TA>TMAX and give a notice to the <tt>park-manager</tt>.
	There are different methods:
  <table style="width:100%" border="1">
		<tr>
			<td style="width:50%">
			<tt>Thermometer</tt> send event when <k>TA</k> surpasses <k>TMAX</k> and when it goes below
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>Reach both components (<tt>Fan</tt> and <tt>ParkServiceStatusGUI</tt>), without knowing them.</dd>
					<dd>Easy to realize.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Logic inside the thermometer.</dd>
				    <dd>No reusability.</dd>
				</dl>
			</td>
		</tr>
		<tr>
			<td style="width:50%">
			<tt>Fan</tt>, <tt>ParkServiceStatusGUI</tt> and <tt>ParkManagerService</tt> observe the <k>TA</k> and act consequently
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>No extra message exchange.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Logic distributed in different actors.</dd>
				</dl>
			</td>
		</tr>
		<tr>
			<td style="width:50%">
			Actor with the logic
			</td>
			<td>
				<dl>
					<dt><k><tt>Pro</tt></k>:</dt> 
					<dd>The logic is separated, meaning future requirements changes won't impact the <tt>thermometer resource</tt>.</dd>
					<dd><tt>thermometer resource</tt> can be reused unchanged in other applications.</dd>
					<dt><k>Cons</k>:</dt> 
					<dd>Not strictly needed.</dd>
				</dl>
			</td>
		</tr>
	</table>
	<br>
	To simplify the model the first option is chosen and will be included in the model after the Analysis. During the project phase, it can be changed based on the architecture adopted.

 <h3>Logical architecture</h3>
  <table style="width:100%" border="1">
		<tr>
			<td rowspan="2" style="width:80%">
			 <img src="img/LogicalArchitecture_2.png" width="100%">
			<td>
				<a href="../src/park_service_model_2.qak">Model SPRINT2</a>
			</td>
			<tr>
				<td><a href="../src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a></td>
			</tr>
		</tr>
  </table>
 <br>
 <!-- <img src="img\LogicalArchitecture_2.png" width="100%"> -->
 <k>See here the <a href="img\legenda.png" target="img">Legenda</a>.</k>
 <!--
	<li>How does the <tt>ParkManagerService</tt> makes sure that during the client interaction between the request to enter and the carenter message, the slot is given to the same client?
	A client could receive the SLOTNUM, then not send a carenter. 
	<br>
	At the moment is assumed that the client always sends a carenter request, so the system keeps the slot occupied after the first request to park. 
	</li>
 -->
 <br>
 <h3>Expected Time</h3>
 Starting from the model already built, the first protoype is expected to be developed in 3 days of work.
<h2>Test plans</h2> 

<h4>Use-case <ks>The <k>TA</k> measured by the <tt>thermometer</tt> is increased over <k>TMAX</k></ks></h4>
 We can send a temperature above, then below, <k>TMAX</k> and simulate a <em>park-manager</em> that stops and starts the <tt>trolley</tt>. 
 <br>
 To check if the test if successful we need to observe the <tt>fan</tt> and the <tt>trolley</tt> state, while also checking that while stopped the trolley doen't move by simulating client requests.
<br> 
 To check if the test is successful we need to observe the <tt>trolley</tt> and the <tt>fan</tt> state.
 <br><br>
 Requirements: <em>manage</em>.
 <br><br>
 <ks>Starting conditions:</ks>
 <ul>
	<li><tt>Transport Trolley</tt> is <tt>home</tt>.</li>
	<li><tt>Transport Trolley</tt> is not stopped.</li>
	<li><tt>Fan</tt> is off.</li>
 </ul>
 
 We expect that, in order:
 <ol>
	<li>The <tt>trolley</tt> state changes to "<k>stopped</k>".</li>
	<li>The <tt>fan</tt> state changes to "<k>on</k>".</li> 
	<li>The <tt>trolley</tt> state changes to "<k>idle</k>".</li>
	<li>The <tt>fan</tt> state changes to "<k>off</k>".</li>
	Also we can check that the trolley doesn't move while stopped by sending parking request and checking that the state didn't change to <k>working</k>.
 </ol>
 <p>JUnit test: <a href="../src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a>
 <br>
 <h4>Use-case <ks><tt>OUTDOOR-area</tt> is not free whithin <tt>DTFREE</tt></ks></h4>
  We can simulate to occupy the <tt>OUTDOOR</tt> and wait a time over <tt>DTFREE</tt>. 
  To check if the test is successful we need to observe the event sent by the sonar that is received by ParkManagerStatusGUI.
  <br><br>
   Requirements: <em>alarm</em>.
 <br><br>
  <ks>Starting conditions:</ks>
  <ul>
	<li><em>OUTDOOR-area</em> is free.</li>
  </ul>
 
 We expect that:
 <ol>
	<li>sonar send an event and ParkManagerStatusGUI receive it.</li>
 </ol> 
 <p>JUnit test: <a href="../src/test/TestPlanUseCase2.kt">TestPlanUseCase2.kt</a></p>

<h2>Project</h2> 

In the project phase we chose to develop the application usign the <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="web">clean code architecture</a>.
 <img src="img\cleanArch.jpg"  width="50%" height="50%">
 <br>
 <!-- D:\Scuola\Registrazioni\Ing\ultimeLezioni -> lezione 20210601 per clean architecture -->
 <br>
 That means we can't use the model as it is, but we need to refactor it to separte the entities and Use-cases, and to respect the <i>Dependecy Rule</i>.
 
 <h3>Code refactor following the clean architecture</h3>
 
 <table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			The <k>Entities</k> do not depend on any operational change in the application, in our case are: <en>weightsensor</en>, <en>sonarsensor</en>, <en>thermometer</en>, <en>fan</en>.
			<br>
			Which receives the respective sensor data and make it avaiable as a CoAp observable resource.
			<br>
			We can keep them as QaKActors, but we need to separate the logic in the <k>Use-cases</k>: <uc>weightlogic</uc>, <uc>sonarlogic</uc>, <uc>thermometerlogic</uc>.
			<br><br>
			For the <en>transporttrolley</en> we separted the logic and the entity, also we added <ia>trolleyintermediary</ia> which is used to maintain the logic of the trolley indipendent from the <fd>basicrobot</fd>.
			<br><br>
			If needed we have to define some adapters to convert our internal data to a format usable by the Graphic interface.
			<br>
			In the external circle there is the <fd>SpringBoot</fd> Web Framework used to develop the <fd>ParkManagerStatusGUI</fd>.
		</td>
		<td>
			<img src="img\myCleanArch.png" width="100%" height="100%">
		</td>
	</tr>
</table>
 
 <h4>weightsensor refactory</h4>
 <table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<img src="img\weightrefactory.png" width="100%">
		</td>
		<td>
			<ol>
				<li>The logic was separated from the component, see <a href="../../../progetto/it.unibo.Weightsensor/src/weightsensor.qak">weightsensor.qak</a>.</li>
				<li>
				We used Prolog logic to implement the application logic. See <a href="../../../progetto/it.unibo.Weightsensor/weightapplogic.pl">weightapplogic.pl</a>.
				<ul>
					<li><k>init(X)</k> "X is the initial state"</li>
					<li><k>modifyStatus(WEIGHT,X)</k> "X is true if <k>| previous weight - the current weight | > delta</k>" </li>
					<li><k>getStatus(WEIGHT,X)</k> "X is the state (free or occupied) to send at the <tt>weightsensor</tt>"</li>
				</ul>
				<ks>NOTE</ks>: <k>reassign</k>, is to change the previous weight, make use of the predicate <a href="https://www.swi-prolog.org/pldoc/doc_for?object=assert/1" target="web">assert</a>, and therefore 
				we can't define the preWeight as a static predicate, so we need to use at runtime <a href="https://www.swi-prolog.org/pldoc/man?predicate=dynamic/1" target="web">dynamic("preWeight/1")</a>, then we need to use the init predicate.
				</li>
				<li>
				When <en>weightsensor</en> receives data from the external sensor (1), sends a local event (2) that is caught by <uc>weightlogic</uc>, we use an event because following the <i>Dependency Rule</i> the <k>Entity</k>
				can't know anything about a component on an outer circle. 
				<br>
				The <uc>weightlogic</uc> the check with the lazy update if we need to change the CoAP observable state of the sensor if we need to it sends a dispatch (2) with the new state.
				</li>
			</ol> 
		</td>
	</tr>
</table>
<h4>sonarsensor refactory</h4>
 <table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<img src="img\sonarrefactory.png" width="100%">
		</td>
		<td>
			<ol>
				<li>The logic was separated from the component, see <a href="../../../progetto/it.unibo.Sonarsensor/src/sonarsensor.qak">sonarsensor.qak</a>.</li>
				<li>
				We used Prolog logic to implement the application logic. See <a href="../../../progetto/it.unibo.Sonarsensor/sonarapplogic.pl">sonarapplogic.pl</a>.
				<ul>
					<li><k>init(X)</k> "X is the initial state"</li>
					<li><k>modifyStatus(DISTANCE,X)</k> "X is true if <k>| previous distance - the current distance | > delta</k>" </li>
					<li><k>getStatus(DISTANCE,X)</k> "X is the state (free or occupied) to send at the <tt>sonarsensor</tt>"</li>
				</ul>
				<ks>NOTE</ks>: <k>reassign</k>, is to change the previous distance, make use of the predicate <a href="https://www.swi-prolog.org/pldoc/doc_for?object=assert/1" target="web">assert</a>, and therefore 
				we can't define the preDist as a static predicate, so we need to use at runtime <a href="https://www.swi-prolog.org/pldoc/man?predicate=dynamic/1" target="web">dynamic("preDist/1")</a>, then we need to use the init predicate.
				</li>
				<li>
				When <en>sonarsensor</en> receives data from the external sensor (1), sends a local event (2) that is caught by <uc>sonarlogic</uc>, we use an event because following the <i>Dependency Rule</i> the <k>Entity</k>
				can't know anything about a component on an outer circle. 
				<br>
				The <uc>weightlogic</uc> the check with the lazy update if we need to change the CoAP observable state of the sensor if we need to it sends a dispatch (2) with the new state.
				</li>
			</ol> 
		</td>
	</tr>
</table>
<h4>thermometer/fan refactory</h4>
 <table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<img src="img\thermometerrefactory.png" width="100%">
		</td>
		<td>
			<ol>
				<li>The logic was separated from the component, see <a href="../../../progetto/it.unibo.Thermometer/src/thermometer.qak">thermometer.qak</a>.</li>
				<li>
				We used Prolog logic to implement the application logic. See <a href="../../../progetto/it.unibo.Thermometer/thermapplogic.pl">thermpapplogic.pl</a>.
				<ul>
					<li><k>init(X)</k> "X is the initial state"</li>
					<li><k>notice(TEMP,X)</k> "X is <k>above</k> or <k>below</k> based on which event is needed" </li>
				</ul>
				<ks>NOTE</ks>: <k>reassign</k>, is to change the flag that tells if the previous temperature was above <k>TMAX</k>, make use of the predicate <a href="https://www.swi-prolog.org/pldoc/doc_for?object=assert/1" target="web">assert</a>, and therefore 
				we can't define the criticTemp as a static predicate, so we need to use at runtime <a href="https://www.swi-prolog.org/pldoc/man?predicate=dynamic/1" target="web">dynamic("criticTemp/1")</a>, then we need to use the init predicate.
				</li>
				<li>
				When <en>thermometer</en> receives data from the external sensor (1), sends a local event (2) that is caught by <uc>thermometerlogic</uc>, we use an event because following the <i>Dependency Rule</i> the <k>Entity</k>
				can't know anything about a component on an outer circle. 
				<br>
				The <uc>thermometerlogic</uc> the check with the lazy update if we need to change the CoAP observable state of the sensor if we need to it sends a dispatch (2) with the new state.
				<br>
				Also, <uc>thermometerlogic</uc> send an event (4) that is caught by the <en>fan</en> that change its state. 
				</li>
			</ol> 
		</td>
	</tr>
</table>
<h4>transporttrolley refactory</h4>
 <table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<img src="img\trolleyrefactory.png" width="100%">
		</td>
		<td>
			<ol>
				<li>The logic was separated from the component, see <a href="../../../progetto/it.unibo.ParkManagerTrolley/src/parkamanagertrolley.qak">parkamanagertrolley.qak</a>.</li>
				<li>
				<en>transporttrolley</en> keeps the state of the <tt>trolley</tt>. <uc>trolleylogic</uc> contains the logic on how to move the <tt>trolley</tt> and how to update the state.
				<ia>trolleyintermediary</ia> is used to maintain the logic indipendent from the <fd>basicrobot</fd>.
				</li>
				<li>
				When <uc>trolleylogic</uc> receives a command from the <tt>parkmanagerservice</tt>, if is a start/stop command send a dispatch to the <en>transporttrolley</en> to change the state, 
				if is a move command sends a event, because of the <i>Dependency Rule</i>, to the <ia>trolleyintermediary</ia>, and if it changes the state send a dispatch to the <en>transporttrolley</en>.
				<br>
				</li>
			</ol> 
		</td>
	</tr>
</table>
 <h3>Concrete architecture</h3>
 <img src="img\ConcreteArchitecture_2.png" width="100%">

 <h3>Graphic interface</h3>

 <h4>Workflow</h4>
 
<h2>Testing</h2> 
 

<h2>Deployment</h2> 

 
<h2>Maintenance</h2> 
 
<!-- USEFUL
<table style="width:100%" border="1">
<tr>
<td style="width:50%">
</td>
<td></td>
</tr>
</table>
-->
	      	
<br/><br/> 	
</div>  

<div style="background-color:rgba(86, 56, 253, 0.9); width:60%;text-align:left;color:white;overflow: auto">
By Emanuele Paci email: emanuele.paci@studio.unibo.it
<br/>
Repository: https://github.com/empaci/Paci-Emanuele-Progetto-Finale-ISS2021
<img src="img\fototessera.png" alt="foto" width="15%" height="15%" style="float:right;">
</div> 
</body>
</html>