<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
	font-size: 93%;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 90%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 90%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	font-size: 90%;
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	font-size: 90%;
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	 
    font-size: 18px;
}
k{
    color: #990000;
	font-weight: bold;
	font-size: 90%;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px;
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #ccffcc;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;

}
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}
div.remark{
	background-color: #E3F2FD;
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed

}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>parkManagerService_3</title></head>
    
<body>
<div id="top">
<h1>LABORATORIO DI INGEGNERIA DEI SISTEMI SOFTWARE <font size="5"></font> </h1>
</div>  

<div class="body"> 
<h2>Introduction</h2>
 
<h2>Requirement</h2> 

<div class="remark">
	<a href="TFBO21ParkingISS.pdf">Link to the requirements file.</a>
</div>

<h2>Summary of the previous SPRINT</h2>

The <k>SPRINT 2</k> document can be found <a href="../../../../SPRINT2/modello/it.unibo.ParkManagerService/UserDocs/parkManagerService_2_a.html">here</a>.
<br>
<h3>Logical architecture resulted from the Analysis of the <k>SPRINT 2</k></h3>
<table style="width:100%" border="1">
		<tr>
			<td rowspan="2" style="width:80%">
			 <img src="img/LogicalArchitecture_2.png" width="80%">
			<td>
				<a href="../../../../SPRINT2/modello/it.unibo.ParkManagerService/src/park_service_model_2.qak">Model SPRINT 2</a>
			</td>
			<tr>
				<td><a href="../../../../SPRINT2/modello/it.unibo.ParkManagerService/src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a></td>
			</tr>
		</tr>
  </table>
  
  <h3>Concrete architecture after the project Phase</h3>
  
  <img src="img\ConcreteArchitecture_2.png" width="80%">
	<br>
	<k>See here the <a href="img\legenda.png" target="img">Legenda</a>.</k>
<h2>In this SPRINT</h2>
In this <k>SPRINT</k> is considered the client's GUI client and every aspect about the communication between the application and the client that was not treated in the previous work.
<h2>Requirement analysis</h2>
 The client GUI should show only the <em>receipt</em> and no other information about the <em>current state</em> of the parking area. 

<h2>Problem analysis</h2>
As stated in the <k>SPRINT 0</k> this problem requires the communications of different components in a distributed environment, see <a href="../../../../SPRINT0/modello/it.unibo.ParkManagerService/userDocs/parkManagerService_0_c.html#problemanalysis">SPRINT0 | problem analysis</a>. 
   
   <h3><ks>Client GUI</h3>
   <table style="width:100%" border="1">
		<tr>
			<td style="width:50%">
			   We need a graphic interface able to:
				<ul>
					<li>Send a request to park the car.</li>
					<li>Receive and show the receipt.</li>
					<li>Press the <em>carenter</em> button to enter the parking slot.</li>
					<li>Send a request to pick-up the car.</li>
					<li>The requestout botton should be active only if it can be used in that moment.</li>
					<li><ks>Optionally</ks> a wait response if the application can't satisfy a request yet..</li>
				</ul>
				<br>
				To grant wide usability the system should be developed as a Web-application. 
				<br>
				<k>SpringBoot</k> should be used to reduce development time.
				<br>
				<br>
				The html page will incude a INPUT section and an OUTPUT section to show the responses.
			</td>
			<td>
				GUI example:
				<center><img src="img\parkserviceGui_example.png" width="40%" height="40%"></center>
			</td>
		</tr>
	</table>
   <br>
 <h3>Other relevant aspects</h3>
 <h4>Client waiting</h4>
 The requirement state that we could optionally respond to the client when the <em>INDOOR-area</em> is occupied. Another solution could be to display a wait message after the client makes the request.
 Which is the most simple way to let the client know that the message is being elaborated and has to wait for the response.
 
 <h4>Client press a button more than once</h4>
 A client could press multiple times or in the wrong order the buttons on the <ks>GUI</ks>. To avoid this we can deactivate the buttons when they can't be used. 
 <br>
 Another way to solve this problem is that the system associates the client with the action already performed, so we need a way to identify the client, 
 for example, we can apply an authorization method.
 <br>
 We can use a username and password authentication, which would also allow us to distinguish between the requests of different clients.
 
 <h4>The client does a requestin but doesn't do a carenter</h4>
 Another problem is that a client could press a request to enter the parking slot, then change their mind and doesn't press carenter.
 The problem is based on the fact that the answer to the first request is, by requirements, the number of the parking slot. Which then is sent back when the client does a carenter.
 <br>
 This method makes sure that a client that did a request in, but not an immediate carenter can still find the slot free, and not occupied by another client.
 <br>
 To solve this problem we can modify the Prolog logic to include that: after a certain time <k>T</k> if the request was not finalized with a carenter we discard it and make the parking slot
 available to the other clients.
 <br>
 To do so we can memorize the time when the request enters the system, with a <tt>TOKENID</tt> set to 0 and set the slot as if it was occupied, 
 if the client does a carenter we set the <tt>TOKENID</tt> to the actual value.
 Periodically we check if a request has been there with a <tt>TOKENID</tt> still 0 for a time over <k>T</k>, in which case we eliminate the request and free the parking slot.
 
 <h4>The client does a carenter but the INDOOR-area is free</h4>
 A problem that we need to resolve is the client that does a carenter, but is not in the <em>INDOOR-area</em>. To avoid this we will process the carenter request only if the <tt>weightsensor</tt> 
 measure a weight in the <tt>INDOOR</tt>.
 
 <h3>Logical Architecture</h3>
 
 <table style="width:100%" border="1">
		<tr>
			<td rowspan="2" style="width:80%">
			 <img src="img/LogicalArchitecture_2.png" width="80%">
			<td>
				<a href="../src/park_service_model_3.qak">Model SPRINT3</a>
			</td>
			<tr>
				<td><a href="../src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a></td>
			</tr>
		</tr>
  </table>
 <br>
 <br>
 See here the <a href="img\legenda.png" target="img">Legenda</a>.
 <br>
 <br>
 <h3>Expected Time</h3>
 Starting from the model, the client's graphic interface is expected to be developed in 1 day of work.

<h2>Test plans</h2> 

<h4>Test the new timedout mechanism </h4>
 We simulate a <ks>N</ks> number of client, and we put a delay between two request to see if the previous request is discarded.
<br> 
 To check if the test is successful we need to observe the parkmanager responses.
 <br><br>
 <ks>Starting conditions:</ks>
 <ul>
	<li><em>INDOOR-area</em> is free.</li>
	<li><em>OUTDOOR-area</em> is free.</li>
	<li>Temperature <k>TA</k><<k>TMAX</k></li>
	<li><tt>Transport Trolley</tt> is <em>home</em> (not stopped).</li>
	<li>The parking slots are not occupied.</li>
 </ul>
 We expect that:
 <ol>
	<li><tt>SLOTNUM</tt> value increases, except for the client with the delay between them, which should give the same value.</li>
 </ol> 
 
 </ol>
 <p>JUnit test: <a href="../src/test/TestPlanUseCase1.kt">TestPlanUseCase1.kt</a>
 <br>

<h4>Test the complete system </h4>
 To test that the system parking element works correctely we can simulate a <ks>a)</ks> enterrequest, <ks>b)</ks> carenter and <ks>c)</ks> pickup request 2 seconds from each other.
<br> 
 To check if the test is successful we need to observe the parkmanager responses.
 <br><br>
 <ks>Starting conditions:</ks>
 <ul>
	<li><em>INDOOR-area</em> is free.</li>
	<li><em>OUTDOOR-area</em> is free.</li>
	<li>Temperature <k>TA</k><<k>TMAX</k></li>
	<li><tt>Transport Trolley</tt> is <em>home</em> (not stopped).</li>
	<li>The parking slots are <ks>0&ltnfree&lt6</ks> free and <ks>0&ltnbusy&lt6</ks> occupied.</li>
 </ul>
 <ks>We expect the following operation from the system:</ks>
 <ol style="PADDING-LEFT: 12px">
	<li>After <ks>a)</ks> the system responds with the free parking slot numbered: <ks>nfree</ks>+1.</li>
	<li>After <ks>b)</ks> the system responds with the token composed by: "'<ks>nfree</ks>+1<ks>'nfree</ks>".</li>
	<li>The trolley moves to the <tt>INDOOR</tt>.</li>
	<li>The trolley moves to the designed parking slot.</li>
	<li>After <ks>c)</ks> the trolley moves to the <tt>OUTDOOR</tt>.</li>
	<li>The trolley waits and moves <tt>home</tt>.</li>
 </ol>
  <ks>We expect the following changes in the state of the system:</ks>
 <ol style="PADDING-LEFT: 12px">
	<li>Nothing changes after <ks>a)</ks>.</li>
	<li>Before <ks>b)</ks> the <tt>weightensor</tt> changes state to <tt>occupied</tt>.</li>
	<li>After <ks>b)</ks> the trolley state changes to <tt>working</tt>.</li>
	<li>After the trolley moved to the <tt>INDOOR</tt> the <tt>weightsensor</tt> changes the state to <ks>free</ks>.</li>
	<li>After <ks>c)</ks> and the trolley moved to the <tt>OUTDOOR</tt> the <tt>sonarsensor</tt> changes state to <ks>occupied</ks>.</li>
	<li>The trolley arrives <tt>home</tt> and changes the state to <tt>idle</tt>.</li>
 </ol>
 <ks>We expect the parking-manager to observe all the changes in the resources.</ks>
 <br>
 <br>
 <ks>We expect the client to observe:</ks>
 <ol style="PADDING-LEFT: 12px">
	<li>A wait message after <ks>a)</ks>.</li>
	<li>An succesful message after receiveing the <tt>SLOTNUMBER</tt>.</li>
	<li>The receipt after <ks>b)</ks>.</li>
	<li>A wait message after <ks>d)</ks>.</li>
 </ol>
 <br>
 <p>JUnit test: <a href="../src/test/TestPlanEnd.kt">TestPlanEnd.kt</a> (without showing the graphic interfaces)
 <br>

<h2>Project</h2> 
 
 <h3>Graphic interface</h3>

  The graphic interface was developed using <k>Springboot</k> and the <ks>mvc pattern</ks>. Note that the model of our application is composed by the <tt>parkingState</tt> and the 
  <en>entities</en>, while this model refers to the one used by the front-end.
  The springboot project that was developed in the prevoius SPRINT has been modified to give the client a new interface an maintaning the parking-manager interface separated.

	<table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<img src="img\parkserviceGUI.png" width="100%">
		</td>
		<td>
			<ol>
				<li>The deactivation of the buttons has not yet been implemented.</li>
				<li><ks><a href="../../../progetto/parkServiceStatus/src/main/kotlin/it/unibo/parkservicestatus/HIController.kt">HIController</a></ks> is a RESTFUL controller used to interface with humans, is a class annoted with <k>@Controller</k> </li>
				<li>Use websocket with <k>STOMP</k> to exchange information between the controller and the webpage.</li>
				<li>The INPUT-section is used to do: <em>RequestIN</em>, <em>RequestOUT</em> and <em>carenter</em>.</li>
				<li>The OUTPUT-section show the system message such as wait and the <em>receipt</em>.</li>
				<li>No information about the state of the system is displayed.</li>
			</ol>
		</td>
	</tr>
</table>

<h3>New Parkmanagerservice logic</h3>
The prolog logic has been modified following the Analysis:
<table style="width:100%" border="1">
	<tr>
		<td style="width:50%">
			<ol>
				<li>After a <tt>requestin</tt> we find the best slot, according to the logic developed in the SPRINT 1, using <k>getFreeSlot(X)</k>. </li>
				<li>Then we use <k>occupySlot(SLOTNUM,TOKENID,CURRENTIME)</k> which temporarily occupies the parking slot with <ks>TOKENID = 0</ks>.</li>
				<li>If the client does a <tt>carenter</tt> we assign the new <tt>TOKENID</tt> with <k>assignToken(TOKENID,SLOTNUM)</k>.</li>
				<li>After a pickup request we use <ks>pickup(TOKENID,SLOTNUM)</ks> to free the parking slot and remove the info about the occupied state.</li>
				<li>Every 10 seconds our application calls <k>timedout(CURRENTIME)</k> which automatically get rid of the request that are stored more than <k>timemax</k> milliseconds ago with <ks>TOKENID=0</ks>, which means they are not really occupied by a car.</li>
				<li>If a client does a <tt>carenter</tt> after a time above <k>timemax</k> if the parking slot is still free we procede normally, otherwise we responde with <tt>TOKENID</tt> = 0.</li>
			</ol>
			See <a href="../parking.pl">parking.pl</a>.
		</td>
		<td>
			<img src="img\explProlog.png" width="100%">
		</td>
	</tr>
</table>

<h2>Testing</h2> 
 

<h2>Deployment</h2> 
<h3>Deployment-1a: on PC and raspberry</h3>
<table style="width:100%" border="1">
	<tr>
		<td style="width:70%">
			<center><img src="img\deployment1a.png" width="100%" height="100%"></center>
			<ol>
				<li>Launch <ks>basicrobot</ks>, <ks>weightsensor</ks>, <ks>sonarsensor</ks>, <ks>thermometer</ks>, <ks>fan</ks> and <ks>ParkmanagerTrolley</ks> on <k>PC</k>.</li>
				<li>Test with the <a href="../pythonMocks">Mocks</a>.</li>
				<li>Launch <ks>sonaronrasp</ks> on <k>RaspberryPi</k>.</li>
				<li>Launch <ks>parkServiceStatus</ks>.</li>
				<li>Go to: http://localhost:8083/manager</li>
				<li>Go to: http://localhost:8083/client</li>
			</ol>
		</td>
		<td>
			Deployment <ks>it.unibo.SonarOnRasp</ks> on <k>raspberryPi</k>:
			<ol>
				<li>Inside <tt>it.unibo.SonarOnRasp</tt> run:</li> 
				<pre>
gradle  -b build2021.gradle distTar
				</pre>
				<li>Copy from <tt>build/distribuition</tt> <k>it.unibo.rasp2021-1.0.tar</k> on raspberry</li>
				<li>Extract the content:</li>
				<pre>
tar -xvf it.unibo.rasp2021-1.0.tar
				</pre>
				<li>Copy in <tt>it.unibo.rasp2021-1.0/bin</tt>: <ks>sysRules.pl</ks>, <ks>sonaronrasp.pl</ks>, <ks>sonar2021ConfigKb.pl</ks></li>
				<li>Copy from <tt>resources/rasp/sonar</tt> <k>SonarAlone.c</k> in <tt>it.unibo.rasp2021-1.0/bin</tt></li>
				<li>Compile <k>SonarAlone.c</k></li>
					<pre>
g++  SonarAlone.c -l wiringPi -o  SonarAlone
					</pre>
				<li>Run:</li>
				<pre>
bash it.unibo.rasp2021
				</pre>
			</ol>
			<pre>
			<p style="font-size:10px">
<tt>pi@raspberrypi</tt>:~/progetto/SPRINT3/it.unibo.rasp2021-1.0/bin $ <k>bash it.unibo.rasp2021</k>
    %%% sysUtil | createTheContext ctxsonaronrasp FOR host=localhost
    %%% CoapResourceCtx ctxsonaronrasp | created
    %%% QakContext |  localhost:8068 INIT
    %%%  ActorBasic  serverctxsonaronrasp |  msg= msg(start,dispatch,serverctxsonaronrasp,
serverctxsonaronrasp,startQakContextServer,3)
    %%% QakContextServer serverctxsonaronrasp | READY TO RECEIVE TCP CONNS on 8068
    %%% QakContext ctxsonaronrasp |  serverCoap started on port: 8068
    %%% sysUtil | createTheContext ctxsonarsensor for DIFFERENT host=127.0.0.1}
    %%% CoapResourceCtx ctxsonarsensor | created
    %%% sysUtil | FOR ACTIVATED CONTEXT ctxsonaronrasp: ADDING A PROXY to ctxsonarsensor
    %%% QakContext ctxsonaronrasp | addCtxProxy ctxsonarsensor
    %%% NodeProxy proxyctxsonarsensor | in ctxsonaronrasp PROXY DONE TO 127.0.0.1:8071
	</p>
			</pre>
		</td>
	</tr>
</table>
<h3>Deployment-1b: on PC and raspberry</h3>
<table style="width:100%" border="1">
	<tr>
		<td style="width:60%">
			<center><img src="img\deployment1b.png" width="100%" height="100%"></center>
			<ol>
				<li>Launch <ks>basicrobot</ks>, <ks>weightsensor</ks>, <ks>sonarsensor</ks>, <ks>thermometer</ks>, <ks>fan</ks> and <ks>ParkmanagerTrolley</ks> on <k>PC</k>.</li>
				<li>Test with the <a href="../pythonMocks">Mocks</a>.</li>
				<li>Launch <ks>sonaronrasp</ks> and <ks>sonarsensor</ks> on <k>RaspberryPi</k>.</li>
				<li>Launch <ks>parkServiceStatus</ks></li>
				<li>Go to: http://localhost:8083/manager</li>
				<li>Go to: http://localhost:8083/client</li>
			</ol>
		</td>
		<td>
		
		</td>
	</tr>
</table>
 
<h2>Maintenance</h2> 
 
<!-- USEFUL
<table style="width:100%" border="1">
<tr>
<td style="width:50%">
</td>
<td></td>
</tr>
</table>
-->
	      	
<br/><br/> 	
</div>  

<div style="background-color:rgba(86, 56, 253, 0.9); width:60%;text-align:left;color:white;overflow: auto">
By Emanuele Paci email: emanuele.paci@studio.unibo.it
<br/>
Repository: https://github.com/empaci/Paci-Emanuele-Progetto-Finale-ISS2021
<img src="img\fototessera.png" alt="foto" width="15%" height="15%" style="float:right;">
</div> 
</body>
</html>